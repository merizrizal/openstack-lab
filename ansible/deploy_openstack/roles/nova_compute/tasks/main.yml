---
- name: Install Nova package
  ansible.builtin.package:
    name: nova-compute
    state: present

- name: Set facts
  ansible.builtin.set_fact:
    transport_url: rabbit://openstack:{{ rabbitmq_password }}@{{ controller01_host_addr }}:5672/
    mgmtnet_ip_address: "{{ node.mgmtnet_ip_address }}"
  vars:
    node: "{{ lookup('ansible.builtin.vars', ansible_hostname) }}"

- name: Setup configuration
  ansible.builtin.include_role:
    name: nova
    tasks_from: main

- name: Reconfigure lvm.conf - set devices/filter
  ansible.builtin.replace:
    path: /etc/lvm/lvm.conf
    regexp: "^(devices {)(\n(.*))*?\n*(# Configuration option devices/dir.).*"
    replace: "{{ lookup('ansible.builtin.template', 'lvm_devices_filter.conf.j2') }}"

- name: Start and enable Nova compute
  ansible.builtin.service:
    name: nova-compute
    state: restarted
    enabled: true
