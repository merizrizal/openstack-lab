---
- name: Initialize CI/CD Servers
  hosts: all
  become: true
  vars_files:
    - "{{ root_dir ~ '/inventories/' ~ target_env ~ '/nodes.yml' }}"
  tasks:
    - name: Get provider network
      openstack.cloud.networks_info:
        name: "{{ provider_network_name }}"
      register: provider_network

    - name: Set provider network id to fact
      ansible.builtin.set_fact:
        network_id: "{{ provider_network.networks[0].id }}"

    - name: Create Gitlab server
      ansible.builtin.include_role:
        name: openstack
        tasks_from: init_server
      vars:
        server_name: "{{ cicd_list.gitlab01.name }}"
        server_flavor: medium.large
        server_volume_size: 50
        server_group: gitlab01

    - name: Create Jenkins server
      ansible.builtin.include_role:
        name: openstack
        tasks_from: init_server
      vars:
        server_name: "{{ cicd_list.jenkins01.name }}"
        server_flavor: medium.large
        server_volume_size: 50
        server_group: jenkins01

    - name: Create Runner server
      ansible.builtin.include_role:
        name: openstack
        tasks_from: init_server
      vars:
        server_name: "{{ cicd_list.runner01.name }}"
        server_flavor: medium
        server_volume_size: 30
        server_group: runner01

    - name: Create CI Monitor server
      ansible.builtin.include_role:
        name: openstack
        tasks_from: init_server
      vars:
        server_name: "{{ cicd_list.ci_monitor01.name }}"
        server_flavor: medium
        server_volume_size: 30
        server_group: ci_monitor01
