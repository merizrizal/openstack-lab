---
- name: Initialize Kubernetes control plane and workers
  hosts: all
  become: true
  vars_files:
    - "{{ root_dir ~ '/inventories/' ~ target_env ~ '/nodes.yml' }}"
  tasks:
    - name: Get self service network
      openstack.cloud.networks_info:
        name: "{{ self_service_network_name }}"
      register: private_network

    - name: Set self service network id to fact
      ansible.builtin.set_fact:
        network_id: "{{ private_network.networks[0].id }}"

    - name: Create Control Plane server
      ansible.builtin.include_role:
        name: openstack
        tasks_from: init_server
      vars:
        server_name: "{{ kubernetes_list.control_plane01.name }}"
        server_flavor: medium
        server_volume_size: 30
        server_group: control_plane01

    - name: Create Worker01 server
      ansible.builtin.include_role:
        name: openstack
        tasks_from: init_server
      vars:
        server_name: "{{ kubernetes_list.worker01.name }}"
        server_flavor: medium
        server_volume_size: 30
        server_group: workers01

    - name: Create Worker02 server
      ansible.builtin.include_role:
        name: openstack
        tasks_from: init_server
      vars:
        server_name: "{{ kubernetes_list.worker02.name }}"
        server_flavor: medium
        server_volume_size: 30
        server_group: workers02
