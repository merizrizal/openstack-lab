---
- name: Validate the inventory variables
  hosts: all
  gather_facts: false
  vars:
    root_dir: "{{ lookup('ansible.builtin.env', 'ROOT_DIR') }}"
    target_env: "{{ lookup('ansible.builtin.env', 'TARGET_ENV') }}"
    excluded_vars:
      - ^molecule
      - ^ansible_config_file$
      - ^ansible_facts$
      - ^ansible_version$
      - ^ansible_verbosity$
      - ^ansible_inventory_sources$
      - ^ansible_playbook_python$
      - ^ansible_skip_tags$
      - ^playbook_dir$
      - ^common_vars_excluded$
      - ^common_vars_list$
  tasks:
    - name: Do mask the secret on the inventory variables
      ansible.builtin.set_fact:
        inventory_vars_json: "{{ vars_as_json_replaced }}"
      vars:
        vars_as_json: "{{ hostvars[inventory_hostname] | to_json | replace(item.value, '***********') }}"
        vars_as_json_replaced: "{{ inventory_vars_json | default(vars_as_json) | replace(item.value, '***********') }}"
      loop: "{{ hostvars[inventory_hostname] | dict2items }}"
      when: "'vault' in item.key and ('pass' in item.key or 'secret' in item.key or 'key' in item.key)"
      no_log: true

    - name: Get inventory variables
      ansible.builtin.set_fact:
        parsed_vars: "{{ cleaned_vars_as_json | from_json }}"
      vars:
        vars_as_json: "{{ hostvars[inventory_hostname] | to_json }}"
        cleaned_vars_as_json: "{{ inventory_vars_json | default(vars_as_json) | replace(root_dir, '$ROOT_DIR') }}"

    - name: Validate common variables
      ansible.builtin.include_tasks:
        file: "{{ molecule_scenario_directory }}/tasks/vars_validation_common_vars.yml"

    - name: Set inventory variables
      ansible.builtin.set_fact:
        inventory_vars: "{{ parsed_vars | ansible.utils.remove_keys(target=excluded_vars_concated, matching_parameter='regex') }}"
      vars:
        excluded_vars_concated: "{{ excluded_vars + common_vars_excluded }}"

    - name: Set expected_items
      ansible.builtin.set_fact:
        expected_items: "{{ base_expected_items + (additional_expected_items | default([])) }}"
      vars:
        base_expected_items:
          - expected_variables: "{{ inventory_common_vars }}"
            json_expected_file: common_vars

          - expected_variables: "{{ inventory_vars }}"
            json_expected_file: "{{ inventory_hostname }}"

    - name: Call verify expected task
      ansible.builtin.include_tasks:
        file: vars_validation_verify_expected.yml
      vars:
        expected_variables: "{{ item.expected_variables }}"
        json_expected_file: "{{ item.json_expected_file }}"
      loop: "{{ expected_items }}"
      loop_control:
        label: "{{ json_expected_file }}"
